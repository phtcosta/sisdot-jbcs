%% BioMed_Central_Tex_Template_v1.06
%%                                      %
%  bmc_article.tex            ver: 1.06 %
%                                       %

%%IMPORTANT: do not delete the first line of this template
%%It must be present to enable the BMC Submission system to
%%recognise this template!!

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                     %%
%%  LaTeX template for BioMed Central  %%
%%     journal article submissions     %%
%%                                     %%
%%          <8 June 2012>              %%
%%                                     %%
%%                                     %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                                                 %%
%% For instructions on how to fill out this Tex template           %%
%% document please refer to Readme.html and the instructions for   %%
%% authors page on the biomed central website                      %%
%% http://www.biomedcentral.com/info/authors/                      %%
%%                                                                 %%
%% Please do not use \input{...} to include other tex files.       %%
%% Submit your LaTeX manuscript as one .tex document.              %%
%%                                                                 %%
%% All additional figures and files should be attached             %%
%% separately and not embedded in the \TeX\ document itself.       %%
%%                                                                 %%
%% BioMed Central currently use the MikTex distribution of         %%
%% TeX for Windows) of TeX and LaTeX.  This is available from      %%
%% http://www.miktex.org                                           %%
%%                                                                 %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%% additional documentclass options:
%  [doublespacing]
%  [linenumbers]   - put the line numbers on margins

%%% loading packages, author definitions

\documentclass[twocolumn]{bmcart}% uncomment this for twocolumn layout and comment line below
%\documentclass{bmcart}

%%% Load packages
%\usepackage{amsthm,amsmath}
%\RequirePackage{natbib}
%\RequirePackage[authoryear]{natbib}% uncomment this for author-year bibliography
%\RequirePackage{hyperref}
\usepackage[utf8]{inputenc} %unicode support
%\usepackage[applemac]{inputenc} %applemac support if unicode package fails
%\usepackage[latin1]{inputenc} %UNIX support if unicode package fails


\usepackage{booktabs} % For formal tables
\usepackage{graphicx}
\usepackage{xspace}
\usepackage{enumerate}
\usepackage{ragged2e}

\usepackage{lstcustom}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                             %%
%%  If you wish to display your graphics for   %%
%%  your own use using includegraphic or       %%
%%  includegraphics, then comment out the      %%
%%  following two lines of code.               %%
%%  NB: These line *must* be included when     %%
%%  submitting to BMC.                         %%
%%  All figure files must be submitted as      %%
%%  separate graphics through the BMC          %%
%%  submission process, not included in the    %%
%%  submitted article.                         %%
%%                                             %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\def\includegraphic{}
%\def\includegraphics{}



%%% Put your definitions there:
\startlocaldefs
\lstdefinelanguage{Xtext}[]{Java}{
	morekeywords={grammar, with, hidden, generate, as, import, returns, current, terminal, enum},
	keywordstyle=[2]{\textbf},
	morestring=[b]",
	tabsize=2,
	numbers=left, 
	numbersep=2pt,
	numberblanklines=false,
	xleftmargin=2em,
	frame=single,
	framexleftmargin=1.5em
}
\newcommand{\lstXtext}[1]{\lstinline[breaklines=true,language=Xtext,basicstyle=\listingsfontinline,mathescape,literate={\-}{}{0\discretionary{-}{}{}}]\S#1\S}


\lstdefinelanguage{Xtend}[]{Java}{
	morekeywords={def, override, val, var},
	keywordstyle=[2]{\textbf},
	morecomment=[l]{//}, 
	morecomment=[s]{/*}{*/}, 
	morestring=[b]",
	showspaces=false,
	tabsize=2, 
	numbers=left, 
	numbersep=2pt,
	numberblanklines=false,
	xleftmargin=2em,
	frame=single,
	framexleftmargin=1.5em
}

\lstdefinelanguage{DRL}[]{Java}{
	morekeywords={rule, when, from, accumulate, and, not, in, then, for, int, end},
	keywordstyle=[2]{\textbf},
	morecomment=[l]{//}, 
	morecomment=[s]{/*}{*/}, 
	morestring=[b]",
	tabsize=2,
	numbers=left, 
	numbersep=2pt,
	numberblanklines=true,
	xleftmargin=2em,
	frame=single,
	framexleftmargin=1.5em
}

\lstdefinelanguage{Freemarker}[]{Java}{
	morekeywords={if, assign, else},
	keywordstyle=[2]{\textbf},
	morecomment=[l]{//}, 
	morecomment=[s]{/*}{*/}, 
	morestring=[b]",
	showspaces=false,
	tabsize=2,
	numbers=left, 
	numbersep=2pt,
	numberblanklines=false,
	xleftmargin=2em,
	frame=single,
	framexleftmargin=1.5em
}

\lstdefinelanguage{DSL}[]{Java}{
	morekeywords={rule, type, materials, conditions, cnds, cond, values},
	keywordstyle=[2]{\textbf},
	morecomment=[l]{//}, 
	morecomment=[s]{/*}{*/}, 
	morestring=[b]",
	showspaces=false,
	tabsize=2, 
	numbers=left, 
	numbersep=2pt,
	numberblanklines=false,
	xleftmargin=2em,
	frame=single,
	framexleftmargin=1.5em
}

\lstdefinelanguage{Cucumber}[]{Java}{
	morekeywords={Feature, Scenario, Given, And, When, Then},
	keywordstyle=[2]{\textbf},
	morecomment=[l]{//}, 
	morecomment=[s]{/*}{*/}, 
	morestring=[b]",
	showspaces=false,
	tabsize=2,
	numbers=left, 
	numbersep=3pt,
	numberblanklines=false,
	xleftmargin=2em,
	frame=single,
	framexleftmargin=1.5em
}

\lstdefinelanguage{Plugin}[]{Java}{
	morekeywords={plugin, groupId, artifactId, version, executions, execution, id, configuration, seed, qcs, goals, goal},
	keywordstyle=[2]{\textbf},
	morecomment=[l]{//}, 
	morecomment=[s]{/*}{*/}, 
	morestring=[b]",
	showspaces=false,
	tabsize=2
}

\newcommand{\callers}{\emph{high-level rules}\xspace}
\newcommand{\shc}{HLR\xspace}
\newcommand{\hlrdsl}{\textsc{HLRDsl}\xspace}



\endlocaldefs




%%% Begin ...
\begin{document}


%%% Start of article front matter
\begin{frontmatter}

\begin{fmbox}
\dochead{Research}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% Enter the title of your article here     %%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\title{On the Use of Metaprogramming and Domain Specific Languages: An Experience Report in the Logistics Domain}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% Enter the authors here                   %%
%%                                          %%
%% Specify information, if available,       %%
%% in the form:                             %%
%%   <key>={<id1>,<id2>}                    %%
%%   <key>=                                 %%
%% Comment or delete the keys which are     %%
%% not used. Repeat \author command as much %%
%% as required.                             %%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\author[
   addressref={aff1},                   % id's of addresses, e.g. {aff1,aff2}
   corref={aff1},                       % id of corresponding address, if any
   %noteref={n1},                        % id's of article notes, if any
   email={pedro.costa@aluno.unb.br}   % email address
]{\inits{PHT}\fnm{Pedro Henrique T.} \snm{Costa}}
\author[
   addressref={aff1},
   corref={aff1},
   email={ednacanedo@unb.br}
]{\inits{ED}\fnm{Edna Dias} \snm{Canedo}}
\author[
	addressref={aff1},
	corref={aff1},
	email={rbonifacio@unb.br}
]{\inits{RB}\fnm{Rodrigo} \snm{Bonif\'{a}cio}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% Enter the authors' addresses here        %%
%%                                          %%
%% Repeat \address commands as much as      %%
%% required.                                %%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\address[id=aff1]{%                           % unique id
  \orgname{Computer Science Department, University of Bras\'{i}lia - (UnB)}, % university, etc
  \street{P.O. Box 4466},                     %
  \postcode{70910-900}                                % post or zip code
  \city{Bras\'{i}lia - DF},                        % city
  \cny{Brazil}                                    % country
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% Enter short notes here                   %%
%%                                          %%
%% Short notes will be after addresses      %%
%% on first page.                           %%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{artnotes}
%\note{Sample of title note}     % note to the article
%\note[id=n1]{Equal contributor} % note, connected to author
\end{artnotes}

%\end{fmbox}% comment this for two column layout

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% The Abstract begins here                 %%
%%                                          %%
%% Please refer to the Instructions for     %%
%% authors on http://www.biomedcentral.com  %%
%% and include the section headings         %%
%% accordingly for your article type.       %%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{abstractbox}

\begin{abstract} % abstract
\justify
In this paper we present the main design and architectural decisions to build an enterprise system that deals with the distribution of equipment to the Brazilian Army. The requirements of the system are far from trivial, and we have to conciliate the need to extract business rules from the source code (increasing software flexibility) with the requirements of not exposing the use of declarative languages to use a rule-based engine and simplifying the tests of the application. Considering these goals, we present in this paper a seamless integration of meta-programming and domain-specific languages. The use of meta-programming allowed us to isolate and abstract all definitions necessary to externalize the business rules that ensure the correct distribution of the equipment through the Brazilian Army unities. The use of a domain specific language simplified the process of writing automatic test cases related to our domain. To support the validation, a strategy of automatic generation of tests based on Property Based Testing was used, together with the realization of a focus group and analysis of collected metrics. Although our architecture targets the specific needs of the Brazilian Army, we believe that logistic systems from other institutions might also benefit from our technical decisions.
\end{abstract}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% The keywords begin here                  %%
%%                                          %%
%% Put each keyword in separate \kwd{}.     %%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{keyword}
\kwd{Software Architecture}
\kwd{Generative Programming}
\kwd{Domain Specific Languages}
\kwd{Rule Engine}
\kwd{Property Based Testing}
\kwd{Military Logistics}
\end{keyword}

% https://cran.r-project.org/web/classifications/MSC.html
% MSC classifications codes, if any
%\begin{keyword}[class=AMS]
%\kwd[Primary ]{}
%\kwd{}
%\kwd[; secondary ]{}
%\end{keyword}

\end{abstractbox}
%
\end{fmbox}% uncomment this for twcolumn layout

\end{frontmatter}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% The Main Body begins here                %%
%%                                          %%
%% Please refer to the instructions for     %%
%% authors on:                              %%
%% http://www.biomedcentral.com/info/authors%%
%% and include the section headings         %%
%% accordingly for your article type.       %%
%%                                          %%
%% See the Results and Discussion section   %%
%% for details on how to create sub-sections%%
%%                                          %%
%% use \cite{...} to cite references        %%
%%  \cite{koon} and                         %%
%%  \cite{oreg,khar,zvai,xjon,schn,pond}    %%
%%  \nocite{smith,marg,hunn,advi,koha,mouse}%%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%







%%%%%%%%%%%%%%%%%%%%%%%%% start of article main body
% <put your article body there>

%%%%%%%%%%%%%%%%
%% Background %%
%%%%%%%%%%%%%%%%



\input{introduction}
\input{background}
\input{methodology}
\input{architecture} 





%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Empirical Study
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Empirical Study}
\label{sec:case_study} 

We conducted an empirical study to validate some
of the architectural decisions discussed in the previous
section. The main goal of this study is to answer
the following research questions:

\begin{itemize}
	\item \textbf{RQ.1}: Does our meta-programming approach generate correct QDMs?
	\item \textbf{RQ.2}: Does the use of a DSL reduce the effort necessary to implement test cases?
          
	\item \textbf{RQ.3}: Does our meta-programming approach generate QDMs within a satisfactory time-frame?
\end{itemize}

\textbf{RQ.1} deals with the most important concern: correctness regarding the QDM generation. It is intended to demonstrate that the solution not only automatically generates the rules, eliminating the work that the developer would have to implement the solution in Java, but also that the proposed approach leads to the expected QDMs when considering a well defined set of \callers. \textbf{RQ.2} is related to the productivity of the tester and demonstrates how much code the developer have to write when using our DSL, compared to the effort to specify \callers using the Java language in unit test cases. During the activities of requirements elicitation,we identified a softgoal stating the  acceptable time for generating a QDM, which should not be above 10 seconds, when using 1000 \callers. Thus, \textbf{RQ.3} serves to ensure that we generate QDMs in a satisfactory time.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Data Collection and Analysis Procedures
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Data Collection and Analysis Procedures}

We answer our first question qualitatively using the focus group method. Although
we did not perform a formal validation, here we give evidences, collected from domain experts, that our approach produces correct QDMs. We believe that this correctness is due to several factors, including the involvement of the domain experts that helped us to full understand the requirements and the expertise of our development team. Nevertheless, the decision of not writing the low-level rules at the source code level, but instead using a program generation approach that has reduced significantly the effort needed to \emph{hand write} those rules, has also contributed to achieve this confidence about correctness. We complement this qualitative
assessment using a combination of unit testing, integration testing, and
\emph{property based testing} approaches that allow us to
test the QDM generation process using more than 300 scenarios. 

We use a quantitative approach to answer the other two research questions.
To this end, we collected two metrics: lines of code (LOC) and execution time. The choice of these two metrics is related to the size of the code, which may indicate higher productivity; and to the fulfillment of the non-functional requirement that determines the maximum execution time for QDM generation. In the quantitative assessment, we use as a benchmark 200 \callers. These \callers correspond to real rules used by the Brazilian Army to perform some tests related to the generation of QDMs. We converted each \shc written using JUnit to their correspondent one specified using our DSL.

% Foram utilizados 200 chamadores, sendo que 100 deles são do tipo ABAS (Estrutura Organizacional por Componentes) e correspondem a chamadores reais utilizados pelo Exército Brasileiro (EB), e serviram para a realização de alguns testes na geração de QDMs pela equipe de desenvolvimento. Foram gerados, de forma automática, 100 chamadores do tipo ÁRVORE (Estrutura Organizacional Completa), para que os dois tipos de chamadores fossem contemplados na realização dos testes.

%% 200 \callers were used, 100 of which are ABAS (Organizational Structure by Components) and correspond to real callers used by the Brazilian Army (EB), and served to perform some tests in the generation of QDMs by the development team. Automatically, 100 \callers of the TREE (Full Organizational Structure) type were generated, so that the two types of \callers could be included in the tests.

%{\color{red}rbonifacio:
 % seria possivel explorar algo como cobertura de codigo aqui? ou
 % explorar alguma coisa da abordagem PBT? Talvez, usando essa informacao,
 % fosse possivel responder a primeira questao de pesquisa usando tanto uma
%abordagem qualitativa quanto uma abordagem quantitativa.}

%{\color{red}pedro: acho que cobertura não vale nesse caso. Mas sobre a abordagem PBT talvez possa falar das combinações da geração automática de testes. EX: QC tem 4 propriedades: tipoOM, natureza, subNatureza e valor ... foram cobertas boa parte das combinacoes: valor-tipoOM (2*2=4 e foram gerados os 4 testes para essas combinacoes); valor-subnatureza, natureza, tipoOM --> 2*4=16 e foram gerados os 16 testes cobrindo essas combinacoes ... OBS:. estou usando * para potencia pra nao dar erro na compilacao}

\subsection{Results of the Qualitative Assessment}

% Para responder a primeira questão de pesquisa nós realizamos um grupo focal com os especialistas do negócio com o objetivo de verificar se os QDMs estavam sendo gerado corretamente pelo sistema e na percepção dos usuários.

To answer the first research question we held a focus group with the business experts in order to verify that the QDMs were being generated correctly by the system and in the users' perception.

Focus groups are carefully planned discussions, designed to obtain the perceptions of the group members on a defined area of interest. There are typically between 3 to 12 participants and the discussion is guided and facilitated by a moderator, who follows a predefined structure so that the discussion stays focused. The members are selected based on their individual characteristics as related to the session topic \cite{kontio2004using}. 

% O grupo focal foi conduzido em três etapas. Na primeira etapa (\emph{defining the research problem}) o objetivo do grupo focal foi definido como o nosso interesse em verificar se a abordagem proposta produzia QDMs corretamente e como os usuários estavam verificando essa corretude. Na segunda etapa (participant selection) foi definido o perfil dos participantes: integrantes da equipe responsável por gerar os QDMs para as organizações militares do Exército Brasileiro. Tais participantes compreendem os principais stakeholders e potenciais usuários finais do SISDOT. Quatro participantes dessa equipe foram selecionados, sendo que todos possuem conhecimento necessário para verificar se o quadro de distribuição de materiais foi realizado corretamente, de acordo com o esperado para cada organização militar, com seu respectivo quantitativo de materiais e cargos.

The focus group was conducted in three stages. In the first stage (defining the research problem) the focal group objective was defined as our interest in verifying that the proposed approach produced QDMs correctly and how users were verifying its correctness. In the second stage (participant selection) the profile of the participants was defined: members of the team responsible for generating the QDMs for the military organizations of the Brazilian Army. Such participants comprise the key stakeholders and potential end users of SISDOT. Four participants of this team were selected, all of whom have the necessary knowledge to verify that the material distribution chart was correctly executed, according to what was expected for each military organization, with its respective quantity of materials and positions.

% Na terceira etapa (executing the focus group session) foi realizada o levantamento das informações com o uso grupo focal, que teve duração de 02 horas e meia e foi realizado nas dependências da 4a. subchefia, responsável pela geração dos QDMs e execução do SISDOT. O grupo focal foi conduzido e gerenciado por dois participantes do projeto, o responsável pelo levantamento dos requisitos e pelo arquiteto responsável pelo desenvolvimento da solução disponibilizada. Inicialmente, foi realizada uma explicação pelo time do projeto sobre os objetivos da realização do grupo focal e quais as expectativas da sua execução. Além disso, foram realizadas perguntas direcionadas aos participantes pelos moderadores. O papel dos dois moderadores foi conduzir as questões e fazer com que os participantes especialistas do negócio descrevessem como as atividades estavam sendo realizadas e verificada a sua conformidade. 

In the third stage (executing the focus group session), the information was collected with the use of the focal group, which lasted for 2 hours and a half and was performed in the 4a. sub-boss, responsible for generating the QDMs and executing the SISDOT. The focus group was led and managed by two project participants, the survey leader and the architect responsible for developing the solution. Initially, an explanation was made by the project team about the objectives of the focus group and what the expectations of its implementation are. In addition, questions were directed to the participants by the moderators. The role of the two moderators was to lead the issues and get the business experts to describe how the activities were being carried out and to verify their compliance.

% Analysis. The focus group session result was documented in the note used during the session and in the audio recording used during the session. Todos os participantes relataram terem executado a funcionalidade de geração de QDMs diversas vezes. \emph{Foi reportado que em nenhuma das execuções levou a uma inconsistência}. Além disso, durante a execução do grupo focal o Major responsável pela 4ª Chefia fez questão de gerar um QDM e nos mostrar como era feita a verificação de conformidade, que segue uma estratégia em pares. Tal Major solicitou ao outro participante para verificar no quadro de cargos qual o quantitativo da OM verificada (AMAN), que é uma das OMs mais complexas em termos de cargos e de materiais necessários para que sejam realizadas as suas atividades militares. O quantitativo desejado e esperado de materiais foi devidamente registrado na geração do QDMs pelos chamadores utilizados para essa geração. Demonstrando assim a geração correta da funcionalidade.

Analysis. The focus group session result was documented in the note used during the session and in the audio recording used during the session. All participants reported performing the QDM generation feature several times. \emph{It was reported that in none of the executions has led to an inconsistency}. Furthermore, during the execution of the focus group the Major responsible for the 4ª Chief made a point of generating a QDM and showing us how the compliance check was carried out, following a strategy in pairs. The Major asked the other participant to verify on the table of positions the amount of verified OM (AMAN), which is one of the most complex OMs in terms of positions and materials needed to carry out their military activities. The desired and expected quantity of materials was duly recorded in the generation of QDMs by the callers used for this generation. Demonstrating the correct generation of functionality.

% Os participantes evidenciaram que a funcionalidade estava sendo realizada corretamente e que a atividade manual que eles realizavam se tornou prática, rápida e confiável. No final da atividade foi feito um agradecimento por parte do responsável pela chefia, dizendo que n\~{a}o imaginava atingir tão rapidamente o grau de corretude na distribuição dos materiais para as OMs.

Participants evidenced that functionality was being performed correctly and that the manual activity they performed became practical, fast and reliable. At the end of the activity, a word of thanks was expressed by the head of the department, saying that he did not expect him to achieve so quickly the degree of correctness in the distribution of the materials to the OMs.

\subsection{Results of the Quantitative Assessment} 

%%%%%%%%%%%%%%%%#######################

 Table \ref{table:comparacao} presents a sample of the collected data. The first column contains the \shc code, the second column contains the number of lines of code to represent the \shc using our DSL, and the third column contains the number of lines of code to represent the same rule in the Java language.

\begin{table}[htb!]
	\centering
	\caption{Comparing the number of lines of code need to specify test cases using our DSL and Java}
	\label{table:comparacao}
	\begin{center}
		\begin{tabular}{ccccc}
			\toprule
			\textbf{\shc Code} & \textbf{DSL} & \textbf{Java} & \textbf{Difference} & \textbf{\%}   \\ \midrule
1                 & 10           & 26            & 16                 & 62                      \\ 
2                 & 10           & 25            & 15                 & 60                      \\ 
3                 & 10           & 32            & 22                 & 69                      \\ 
4                 & 11           & 52            & 41                 & 79                      \\ 
5                 & 15           & 41            & 26                 & 64                      \\ 
6                 & 9            & 16            & 7                  & 44                      \\ 
7                 & 18           & 21            & 3                  & 15                      \\ 
8                 & 12           & 25            & 13                 & 52                      \\ 
9                 & 9            & 11            & 2                  & 19                      \\ 
10                & 11           & 23            & 12                 & 53                      \\ 
122               & 10           & 48            & 38                 & 80                      \\ 
123               & 8            & 44            & 36                 & 82                      \\ 
124               & 10           & 54            & 44                 & 82                      \\ 
125               & 8            & 39            & 31                 & 80                      \\ 
126               & 12           & 47            & 35                 & 75                      \\ 
127               & 9            & 43            & 34                 & 80                      \\ 
128               & 9            & 39            & 30                 & 77                      \\ 
129               & 9            & 27            & 18                 & 67                      \\ 
130               & 12           & 25            & 13                 & 52                      \\ 
131               & 12           & 45            & 33                 & 74                      \\ \bottomrule
		\end{tabular}
	\end{center}
\end{table}

Regarding the runtime metrics, we collected the data using an Intel(R) Core{TM} i7-4790 processor, with 16GB of RAM, running Ubuntu 16.04.4 LTS 64-bit operating system, with 4.15.0-24-generic kernel. We used 100 QCs, chosen to represent the various OM types, natures, and sub-natures. For each QC, we generated QDMs using random sets of \callers with size: 400, 700, 1000, 1500, 2000. Since there were only 200 real \callers already declared, larger quantities contain repeated \callers (which in the end will duplicate the data within a given QDM). The selection of \callers was performed at random, but with the same seed, so that the same sets were used in the generation of QDMs for different QCs. Table \ref{table:tempo} shows a sample of the results obtained with the execution. The first column contains the QC code, and the second column contains the time in milliseconds for the generation of the QDMs using the indicated amount of \callers on the respective column header.

%AMAN=7006000

\begin{table}[htb!]
	\centering
	\caption{Time (ms) for generation of QDMs}
	\label{table:tempo}
	\begin{center}
		\begin{tabular}{|l|r|r|r|r|r|}
			\toprule
			\textbf{QC} & \textbf{400} & \textbf{700} & \textbf{1000} & \textbf{1500} & \textbf{2000} \\ \midrule
101410   & 1866      & 3237      & 4846       & 6877       & 9231       \\
206410   & 1875      & 3170      & 4838       & 6975       & 9348       \\
%215304   & 2026      & 3358      & 5235       & 6851       & 9416       \\
231303   & 1954      & 3221      & 4931       & 6715       & 9264       \\
300400   & 1903      & 3132      & 4808       & 6858       & 9283       \\
500312   & 1992      & 3495      & 4709       & 6637       & 9213       \\
%524311   & 1999      & 3231      & 4991       & 7061       & 9686       \\
%609420   & 1895      & 3162      & 4875       & 6905       & 9259       \\
%619321   & 1945      & 3269      & 5010       & 6976       & 9163       \\
%627320   & 2006      & 3314      & 5081       & 7522       & 9011       \\
%656320   & 1868      & 3197      & 5058       & 7086       & 9398       \\
702311   & 2902      & 4301      & \textbf{6185} & 7753       & 10098      \\
710312   & 1996      & 3237      & 4861       & 6728       & 9102       \\
725310   & 1872      & 3104      & 4860       & 6957       & 9190       \\
727310   & 1949      & 3206      & 4722       & 6795       & 9222       \\
757311   & 2084      & 3359      & 5263       & 6960       & 9230       \\
950401   & 1993      & 3235      & 5076       & 7282       & 10060      \\
1108400  & 2048      & 3458      & 4703       & 6727       & 9575       \\
1112401  & 1880      & 3165      & 4837       & 6873       & 9270       \\
5716900  & 1979      & 3423      & \textbf{4662} & 6504       & 9032       \\
7006000  & 1948      & 3149      & 5003       & 6998       & 9326       \\
7805004  & 1808      & 2979      & 4710       & 6915       & 9287       \\
1470310  & 1861      & 3091      & 4711       & 6824       & 8996       \\
739310   & 1962      & 3096      & 4722       & 6753       & 9032       \\
8204900  & 1841      & 3052      & 4731       & 6907       & 9348       \\
1501402  & 1869      & 3092      & 4784       & 6873       & 9581       \\
6512900  & 1882      & 3161      & 4796       & 6825       & 9691       \\
%2522135  & 1890      & 3115      & 4819       & 6928       & 9153       \\
%302401   & 1871      & 3080      & 4898       & 6875       & 9272       \\
%1115310  & 1857      & 3131      & 4904       & 6891       & 9201       \\
%7038901  & 1955      & 3268      & 5026       & 7450       & 9241       \\
%6800901  & 1870      & 3138      & 4895       & 6982       & 8975       \\
%6993900  & 1861      & 3090      & 4741       & 6793       & 9445       \\
%2205400  & 1890      & 3186      & 5038       & 7107       & 9146       \\
%7017901  & 1852      & 3061      & 4773       & 6760       & 9201       \\
%2587150  & 1854      & 3147      & 5132       & 6902       & 9034       \\
%8417000  & 1917      & 3191      & 4892       & 7010       & 9061       \\
%903311   & 1910      & 3180      & 4843       & 6950       & 9346       \\
%9015002  & 1893      & 3070      & 4783       & 6792       & 8989       \\
5406194  & 1924      & 3124      & 4870       & 6749       & 8955       \\ \bottomrule
		\end{tabular}
	\end{center}
\end{table}

We exported the collected data to the CSV format, so that we could perform a data analysis using the R environment~\cite{crawley2013}. In the data analysis for \textbf{RQ.2}, which compares the number of lines of code between the two distinct approaches for representing \callers, we created two additional columns: \emph{difference}, which measures the difference in the number of lines of code necessary to specify \callers using Java and our DSL; and \emph{percent of reduction}, which indicates how much less code is necessary to specify a \shc using our DSL, when compared to the direct specification in Java code.

\begin{table}[htb!]
	\centering
	\caption{Analysis of DSL and Java comparison data}
	\label{table:analiseComparacao}
	\begin{center}
		\begin{tabular}{lrrrrr}
			\toprule
			& \textbf{Min.}  & \textbf{Median} & \textbf{Mean}  & \textbf{SD}    & \textbf{Max.}  \\ \midrule
DSL         & 7.00  & 9.00   & 9.67  & 2.01  & 18.00  \\ 
Java        & 9.00  & 23.00  & 28.66 & 18.47 & 130.00 \\ 
Difference  & 2.00  & 13.00  & 18.98 & 18.25 & 121.00 \\ 
\%	        & 14.29 & 56.26  & 54.66 & 21.68 & 93.08  \\ \bottomrule
		\end{tabular}
	\end{center}
\end{table}

Table \ref{table:analiseComparacao} presents some descriptive statistics of the collected data, containing the following columns: minimum value, median, mean, standard deviation, and maximum value. There is a strong correlation (0.982) between the lines of code in Java and the \emph{difference} measurements. This correlation can be seen in Figure \ref{fig:correlacao}. It is possible to identify that as the size of the Java code grows, the difference for the representation in DSL also increases.

\begin{figure}[htb!] 
	\centering
	\includegraphics[width=.45\textwidth]
	{img/artigo_correlacao.png}
	\caption{\it Correlation between Java and Difference}
	\label{fig:correlacao}
\end{figure}

Figure \ref{fig:geracao} shows the time necessary to generate QDMs for 5 different QCs. For each of them, 5 QDMs were generated, with different amounts of \callers, 400, 700, 1000, 1500 and 2000.

\begin{figure}[!ht] \centering
	\includegraphics[width=.45\textwidth]
	{img/artigo_geracao.png}
	\caption{\it QDM Generation Time (ms)}
	\label{fig:geracao}
\end{figure}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Discussion, Lessons Learned, and Threats to Validity
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Discussion and Threats to Validity}
\label{threats}

When analyzing the data related to RQ.2, it was possible to realize that the representation of a \shc using our DSL is on average 54\% smaller than the representation of the same rule in Java. This indicates a possible productivity gain for the developer when writing test cases, since she will have to write a smaller amount of code. In addition, using our DSL, we specify \callers using a declarative approach, which is close to the vocabulary of the problem domain. With respect to the third research question, the limit imposed by the functional requirement of 10 seconds was not exceeded, even when considering 2000 \callers, which is twice the number of \callers expected for the system in production. It is important to notice that these number (10 seconds as time limit and 1000 \callers were collected together with the stakeholders of SISDOT).

The general approach discussed in this paper involves the use of metaprogramming to generate low-level Drools rules from \callers and the use of a DSL to specify \callers during test activities. We have some previous experience using Drools, and, at the beginning of this research collaboration, we realized that the use of a rule based engine (such as Drools), could simplify the computation of QDMs (one of the main products of SISDOT). Nevertheless, we should try to abstract the use of Drools, mostly due to architectural conformance---we should not introduce new languages during the development of SISDOT. For this reason, we applied a transformational approach, translating Java domain objects into Drools rules at runtime. Perhaps due to the structure of the \callers, the task of implementing this transformational approach was not difficult. We believe that it was the right decision considering the original set of requirements. Surely, a number of uncertainties arise, including: ``will our proposed approach support the expectations of the end-users w.r.t. correctness and time constraints?''. We address this question in our empirical evaluation.

However, we found that testing the process of QDM generation was time consuming, and then we designed a DSL to address the main bottleneck: the specification of \callers either using Java test scripts or the SISDOT user interface (the common way for specifying \callers). Our choice for using Xtext to this end had simplified the entire process for implementing a DSL. Even considering that \hlrdsl is a simple and small DSL, we argue that the set of Xtext tools is really simple and productive, reducing the overall effort to implement the \hlrdsl grammar, parser, and program generator. We could have used other tools and techniques as well, for instance a metaprogramming approach to support our test activities. However, such approach would not have solved the main problem that motivated us to implement \hlrdsl. In this case, our goal was to design a simple approach for specifying \callers. In the end, \hlrdsl started to be considered an interesting approach for use not only in test activities, but also for simulating QDMs without the need to persist \callers in the production environment. 

Our empirical study presents several limitations. First, we discuss \emph{correctness} based on the results of both integration and acceptance tests, though also considering the opinion of the domain experts that are currently confident that our approach for QDM generation is working properly. Surely, we could have used a more formal approach for discussing correctness, and we postpone this investigation to a future work. Nevertheless, considering the scope of this paper, the feedback from the domain experts and testing outcomes reduce some of ours uncertainties about correctness. 

Second, we only considered 200 real \callers in our study, which served as a basis for measuring the time to generate QDMs. SISDOT is expected to have around 1000 \callers in the production environment. To mitigate the threat related to the small number of available \callers for testing, we considered their repetition when carrying out a performance test of SISDOT. In this way, we expect that the system would present a behavior similar to the production environment (with respect to performance). The same situation occurs with the comparison of lines of code between the declarations of \callers in DSL and Java. As the number of \callers is relatively small, it may not be possible to generalize the results we found.









%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Related Work
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Related Work}
\label{sec:related}

We addressed the main architectural concerns of SISDOT using well-known patterns for enterprise systems~\cite{enterprise-patterns:book} and software architecture patterns ~\cite{pattern-oriented:book}. Moreover, the ideas of using rule based engines to support inference within software systems are also not new~\cite{ORDONEZ2016353,li2012modeling}, and have been particularly explored in the health domain~\cite{mantas2012comparing,li2012modeling,jung2011executing}. For instance, Van Hille et al. present a comparison between Drools and OWL + SWRL for implementing the reasoning procedures of the alert module of an implantable cardioverter defibrillator. The authors conclude that Drools provides greater expressiveness when compared to the other approach. Our decision to use Drools to implement low-level rules was mostly based on its integration to the JEE platform, instead of its expressiveness.
% We also considered the use of Prolog for at least
% expressing the mechanics of the QDM generation, though
% we postponed this work to a future work.

Dingcheng Li and colleagues report on the use of the Drools engine to model and reason about \emph{electronic health records}~\cite{li2012modeling}. To this end, the authors of this mentioned work implemented a \emph{model-to-model translational approach} that converts the specification of phenotyping algorithms expressed using the Quality Data Model (from the National Quality Forum\footnote{http://www.qualityforum.org/Home.aspx}) into Drools rules. Similarly, Jung et al. present an approach for executing medical logic modules expressed in ArdenML using Drools~\cite{jung2011executing}. They also used a model-to-model approach implemented using XSLT. Our approach could also be characterized as being based on \emph{model-to-model transformations}, since we translate a business entity model (represented as the \callers Java domain objects at runtime) into Drools rules, though using FreeMarker as template engine.
% The work of Ostermayer et al. also advocates
% the use of DSLs + template engines to generate Drools
% rules~\cite{toostermayer2013simplifying}.

Several DSLs have been proposed to support test activities. For instance, Mugridge and Cunningham present the \emph{Fit Framework for Integrated Tests}, which is based on a DSL~\cite{Mugridge:2005:FDS:1051337} The Cucumber framework also uses a DSL for expressing the expected behavior of software features~\cite{Wynne:2012:CBB:2331446}. Here, we designed a small DSL to reduce the effort for setting up a suite of acceptance tests (based on Cucumber) for QDM generation, particularly helping the test team to specify \callers. 









%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Final Remarks
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Final Remarks}
\label{sec:conclusao}

In this paper we detailed the main design and architectural decisions we use to implement the mechanisms necessary to support the distribution of materials through the Brazilian Army unities. These decisions included the use of a metaprogramming approach to derive high level business rules in rules specific to a rule based system (Drools) and the definition of a DSL that facilitates the declaration of \callers to build test scripts. 

We carried out an empirical study to validate the proposed architecture, based on the evaluation of one of the main scenarios of our logistic system (SISDOT), related to the generation of QDMs. From the results obtained, it was possible to observe a reduction in the average number of lines of code required for the declaration of a \callers using our DSL, in comparison with the representation of the same \shc in Java. Another result of the case study shows that our approach fulfills a non functional requirement that constraints the expected time to generate QDMs. This limit was not exceeded even when using twice the number of \callers expected for the system in production environment.

Although the architecture discussed here considers the specific needs of the Brazilian Army, we believe that logistic systems from other institutions might benefit from our technical decisions as well.





%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% Backmatter begins here                   %%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{backmatter}

\section{Competing interests}
  The authors declare that they have no competing interests.

\section{Author's contributions}

  Authors contributed equally to this work. 

\section{Acknowledgements}
We would like to thank the anonymous referees for the valuable comments and suggestions, which have led to several improvements of this paper. This work is partially supported by \textsc{PROMISE-EB}, a software modernization project involving the University of Bras\'{i}lia and the Brazilian Army.
  
  
  
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                  The Bibliography                       %%
%%                                                         %%
%%  Bmc_mathpys.bst  will be used to                       %%
%%  create a .BBL file for submission.                     %%
%%  After submission of the .TEX file,                     %%
%%  you will be prompted to submit your .BBL file.         %%
%%                                                         %%
%%                                                         %%
%%  Note that the displayed Bibliography will not          %%
%%  necessarily be rendered by Latex exactly as specified  %%
%%  in the online Instructions for Authors.                %%
%%                                                         %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% if your bibliography is in bibtex format, use those commands:
\bibliographystyle{bmc-mathphys} % Style BST file (bmc-mathphys, vancouver, spbasic).
\bibliography{bibliography}      % Bibliography file (usually '*.bib' )
% for author-year bibliography (bmc-mathphys or spbasic)
% a) write to bib file (bmc-mathphys only)
% @settings{label, options="nameyear"}
% b) uncomment next line
%\nocite{label}

% or include bibliography directly:
% \begin{thebibliography}
% \bibitem{b1}
% \end{thebibliography}


\end{backmatter}


\end{document}
